# VM Template for Windows Server 2022 VMs
# Copy this template and modify for each new VM

# Example: Active Directory Domain Controller
resource "libvirt_domain" "ad_dc" {
  name        = "ad-dc-01"
  memory      = 4096
  memory_unit = "MiB"  # CRITICAL: Always specify!
  vcpu        = 2
  type        = "kvm"

  # Must match the original sysprepped image configuration
  os = {
    type         = "hvm"
    type_arch    = "x86_64"
    type_machine = "pc-q35-8.2"  # Match original VM
  }

  devices = {
    # Disk Configuration
    disks = [
      {
        driver = {
          name = "qemu"
          type = "qcow2"  # Must match your image format
        }
        source = {
          file = {
            # IMPORTANT: Each VM needs its own disk file!
            # Don't reuse the same qcow2 across multiple VMs
            file = "/var/lib/libvirt/images/ad-dc-01.qcow2"
          }
        }
        target = {
          dev = "sda"
          bus = "sata"  # SATA for Windows (no drivers needed)
        }
      }
    ]

    # Network Configuration
    interfaces = [
      {
        model = {
          type = "virtio"
        }
        source = {
          network = {
            network = "default"  # or your custom network
          }
        }
      }
    ]

    # Graphics/Console
    graphics = [
      {
        vnc = {
          autoport = true
        }
      }
    ]
  }
}

# Example: SQL Server Node
resource "libvirt_domain" "sql_node_01" {
  name        = "sql-node-01"
  memory      = 8192  # SQL Server needs more RAM
  memory_unit = "MiB"
  vcpu        = 4
  type        = "kvm"

  os = {
    type         = "hvm"
    type_arch    = "x86_64"
    type_machine = "pc-q35-8.2"
  }

  devices = {
    disks = [
      # OS Disk
      {
        driver = {
          name = "qemu"
          type = "qcow2"
        }
        source = {
          file = {
            file = "/var/lib/libvirt/images/sql-node-01.qcow2"
          }
        }
        target = {
          dev = "sda"
          bus = "sata"
        }
      },
      # Optional: Data disk for SQL databases
      {
        driver = {
          name = "qemu"
          type = "qcow2"
        }
        source = {
          file = {
            file = "/var/lib/libvirt/images/sql-node-01-data.qcow2"
          }
        }
        target = {
          dev = "sdb"
          bus = "sata"
        }
      }
    ]

    interfaces = [
      {
        model = {
          type = "virtio"
        }
        source = {
          network = {
            network = "default"
          }
        }
      }
    ]

    graphics = [
      {
        vnc = {
          autoport = true
        }
      }
    ]
  }
}

# Before using this template:
# 1. Copy your base image for each VM:
#    sudo cp /path/to/base.qcow2 /var/lib/libvirt/images/vm-name.qcow2
#
# 2. Set correct permissions:
#    sudo chown libvirt-qemu:kvm /var/lib/libvirt/images/vm-name.qcow2
#
# 3. Update the resource name, VM name, and disk path
#
# 4. Adjust memory/vcpu based on workload:
#    - AD DC: 4GB RAM, 2 vCPU
#    - SQL Server: 8-16GB RAM, 4-8 vCPU
#
# 5. Run: terraform plan
# 6. Run: terraform apply
